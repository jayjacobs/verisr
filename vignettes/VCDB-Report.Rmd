---
title: "Sample VCDB Report"
author: "Jay Jacobs"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r echo=FALSE, warning=FALSE}
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(data.table))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(scales))
suppressPackageStartupMessages(library(gridExtra))
suppressPackageStartupMessages(library(tidyr))
suppressPackageStartupMessages(library(binom))
suppressPackageStartupMessages(library(knitr))
suppressPackageStartupMessages(library(verisr))
suppressPackageStartupMessages(library(pbapply))
suppressPackageStartupMessages(library(rjson))
opts_chunk$set(echo=TRUE, warning=FALSE, message=FALSE,
               results="markdown", prompt=FALSE, error=FALSE,
               #fig.width=8, fig.height=5, 
               cache=FALSE)

theme_set(theme_minimal() + 
            theme(panel.background=element_rect(fill="floralwhite", color="gray75"),
                  panel.grid.major=element_line(color="gray75", size=0.1),
                  axis.ticks=element_blank(),
                  title = element_text(face="italic", size=10)
          ))

```

In order to run a report, we need to first load up the data.  In this case I will load up the data from the VERIS Community Database (VCDB)^[http://vcdb.org/].

```{r}
vz <- json2veris("~/Documents/github/VCDB/data/json/")
```


Perhaps you would like to run a report on just a subset of the overall data, if that's the case, just filter the data (using `dplyr`).  Note, this filter is not run on the data set for this sample, it's just here as an example. 

```{r eval=FALSE}
vz <- vz %>% filter(attribute.confidentiality.data.variety.Credentials) 
```


We can pull out some numbers here too...

```{r}
fullrows <- format(nrow(vz), big.mark=",", scientific=F)
vrows <- format(nrow(vz), big.mark=",", scientific=F)
ddyes <- format(sum(vz$attribute.confidentiality.data_disclosure.Yes), big.mark=",", scientific=F)
ddpot <- format(sum(vz$attribute.confidentiality.data_disclosure.Potentially), big.mark=",", scientific=F)
```

# Sample Report on the VCDB data set

There was no filter applied this data.

### At a Glance: `r vrows` incidents, `r ddyes` breaches (with additional `r ddpot` potential).

Before we get too far, let's look at some evaluations of this data set.  We can do that through the "ccc" function and get scores around the completeness, context and complexity of the data set.

### Completeness Scoring

A "completeness" score is calculated for each incident.  A score of 1 is assigned if the category has at least one complete section.  For example, if the incident has the motive and variety for an external actor, the actor category will be scored a 1, if an internal actor has motive specified, but variety is unknown, the actor.internal will get a score of 0.5 (mean of 0 for variety and 1 for motive), but the overall actor will still be scored as a 1 since the external actor was complete.

The text at the top is the average score across all incidents.  

* *Poor* is missing two or more enumerations (1/3rd or 1/4th or less specified in that cateogry)
* *Some* is missing one entire enumeration (1/2 or 2/3rds of fields in the category)
* *Perfect* is a full enumeration (all enumerations had non-unknown value in the cateogry)

```{r fig.height=3, fig.width=10}
ccc <- getccc(vz)
simpled <- tbl_df(ccc[ ,1:8]) %>% gather(type, score) 
avgs <- simpled %>% group_by(type) %>% summarize(score=mean(score)) %>%
  mutate(label=paste0(round(score, 3)*100, "%"), clabel="Some")
cuts <- simpled %>% 
  mutate(clabel=cut(score, breaks=c(-0.1,0.4,0.99, 1), 
                    labels=c("Poor", "Some", "Perfect"))) %>%
  group_by(type, clabel) %>% tally %>% 
  group_by(type) %>% mutate(sums=sum(n), freq=n/sums)
  
cuts$clabel <- factor(cuts$clabel, levels=rev(c("Poor", "Some", "Perfect")), ordered=T)
ggplot(cuts, aes(clabel, freq, fill=clabel)) + facet_wrap(~type, nrow=1) + 
  geom_bar(stat="identity")  + 
  scale_y_continuous("Percentage of Incidents", breaks=seq(0,1,by=0.1),
                     label=percent, expand=c(0,0), limits=c(0,1)) +
  scale_fill_manual(values = rev(c("#fbb4ae", "#b3cde3", "#ccebc5"))) +
  geom_text(data=avgs, aes(clabel, label=label), y=0.92, size=4) +
  xlab("") + theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.3),
                   legend.position="None")
```

It's clear there are some issues around the context (timeline, discovery method and targeted data points).

### Complexity 

The data complexity refers to how many fields were populated.  The closer the `score` is to 1 the better. A higher `score` indicates a full incidents with good variety across the set of incidents.  A score of exactly zero occurs when there is no variation in the source data.  The `mean` represents the average number of critical fields (denoted above in the Completenes section) that were specified, and the `sd` is the standard deviation from the mean. _Note: Score = sqrt(mean*sd)/12_


```{r fig.height=1.5, fig.width=5}
# this will calculate 1.5 * IQR to filter off "outliers" to calculate a
# trimmed standard deviation
thec3 <- tbl_df(ccc) %>% 
  select(completeness, context, complexity)  %>% 
  mutate(iqr=1.5*IQR(complexity), 
         lwr=quantile(complexity, probs=c(.25))-iqr, 
         upr=quantile(complexity, probs=c(.75))+iqr) %>%
  filter(complexity >= lwr, complexity <= upr) %>%
  summarize(mean=round(mean(complexity), 2), 
            sd=round(sd(complexity), 2)) %>%
  mutate(Score=round((sqrt(mean*sd))/12, 2)) %>%
  select(Score, mean, sd) %>%
  gather(wh, score) %>% 
  mutate(x=1, y=1)

  ggplot(thec3, aes(x, y, label=score)) + geom_text(size=8) + 
  facet_wrap(~wh) + theme(axis.text=element_blank(),
                          axis.title=element_blank(),
                          panel.margin=unit(c(10), "points"))
```

### Categories

One of the more convenient functions is the `setjenum` which can take in one or more enumeration fields to query and put into a single plot.

```{r warning=F}

chunk <- setjenum(vz, c("actor", "action", "asset.variety")) # , ht_mult=0.22, ht_pad=2)
```
```{r fig.width=8.5, fig.height=chunk$ptall}
print(plotjchunk(chunk))
```

Note that this 
### Patterns

```{r}
chunk <- setjenum(vz, c("pattern"))
```

Once we have the returned value from `setjenum` we can pull out the suggested figure height in the `chunk$ptall` variable.  We can use that to set the height, in this case the height is set to `r chunk$ptall`.   The function `plotjchunk` will display it nicely and by default it will show the "analyst" view, with count and percentages.

```{r fig.width=8.5, fig.height=chunk$ptall}
print(plotjchunk(chunk))
```

But we can pass in the "final" variable and get a more polished view. 

```{r fig.width=8.5, fig.height=chunk$ptall}
print(plotjchunk(chunk, final = TRUE))
```

Convenience function, the A4 grid, first seen in the 2011 DBIR.

```{r, fig.width=8, fig.height=6}
plota4(vz, "A4 Grid")
```

# Victim Demographics

The Victim Demographics section describes (but does not identify) the organization affected by the incident. The primary purpose is to aid comparisons between different types of organizations (across industries, sizes, regions, etc) or departments within a single organization.  

VERIS uses standard NAICS codes to identify industries and we are showing the first two digits here. NAICS provides descriptions at http://www.census.gov/cgi-bin/sssd/naics/naicsrch?chart=2012.


```{r fig.width=8.5, fig.height=4}
print(getindemp(vz))
```

VERIS uses the ISO 3166 codes for the country variable, which can be found at the iso.org website: http://www.iso.org/iso/country_codes.htm. 

```{r warning=F}
chunk <- setjenum(vz, c("victim.country"))
```
```{r fig.width=8.5, fig.height=chunk$ptall}
print(plotjchunk(chunk))
```

It's also possible to look right into the data and pull out values. 

```{r}
ncount <- format(nrow(vz), big.mark=",", scientific=F)
secondary <- paste0("Out of the ", ncount, 
                    " incidents, there were no secondary victims recorded.")
scount <- sum(!is.na(vz$victim.secondary.amount))

if (scount>0) {
  secondary <- paste0("Out of the ", ncount, 
                    " incidents, there were *", 
                      format(scount, big.mark=",", scientific=F), 
                      " incidents* with secondary victims.")
}
```

`r secondary`

# Actor

Entities that cause or contribute to an incident are referred to as threat actors. There can be more than one actor involved in any particular incident, and their actions can be malicious or non-malicious, intentional or unintentional, causal or contributory. VERIS recognizes three primary categories of threat actors - External, Internal, and Partner.

_VERIS classification note: If the actor’s role in the breach is limited to a contributory error, the actor would not be included here. For example, if an insider’s unintentional misconfiguration of an application left it vulnerable to attack, the insider would not be considered a threat actor if the application were successfully breached by another actor. An insider who deliberately steals data or whose inappropriate behavior (e.g., policy violations) facilitated the breach would be considered a threat actor in the breach._

### External Actors

External threats originate from sources outside of the organization and its network of partners. Examples include criminal groups, lone hackers, former employees, and government entities. Also includes God (as in “acts of”), “Mother Nature,” and random chance. Typically, no trust or privilege is implied for external entities.

```{r warning=F}
chunk <- setjenum(vz, c("actor.external.variety", "actor.external.motive"))
```
```{r fig.width=8.5, fig.height=chunk$ptall}
print(plotjchunk(chunk))
```

```{r warning=F}
chunk <- setjenum(vz, c("actor.external.country"))
```
```{r fig.width=8.5, fig.height=chunk$ptall}
print(plotjchunk(chunk))
```

### Internal Actors

Internal threats are those originating from within the organization. This encompasses company full-time employees, independent contractors, interns, and other staff. Insiders are trusted and privileged (some more than others).

```{r warning=F}
chunk <- setjenum(vz, c("actor.internal.variety", "actor.internal.motive"))
```
```{r fig.width=8.5, fig.height=chunk$ptall}
print(plotjchunk(chunk))
```

### Partner Actors

Partners include any third party sharing a business relationship with the organization. This includes suppliers, vendors, hosting providers, outsourced IT support, etc. some level of trust and privilege is usually implied between business partners.

```{r warning=F}
chunk <- setjenum(vz, c("actor.partner.motive", "actor.partner.country"))
```
```{r fig.width=8.5, fig.height=chunk$ptall}
print(plotjchunk(chunk))
```

# Threat Actions

Threat actions describe what the threat actor(s) did to cause or contribute to the incident. Every incident has at least one, but most will comprise multiple actions (and often across multiple categories). VERIS uses 7 primary categories of threat actions: Malware, Hacking, Social, Misuse, Physical, Error, and Environmental.


### Malware

Malware is any malicious software, script, or code run on a device that alters its state or function without the owner’s informed consent. Examples include viruses, worms, spyware, keyloggers, backdoors, etc.

```{r warning=F}
chunk <- setjenum(vz, c("action.malware.variety", "action.malware.vector"))
```
```{r fig.width=8.5, fig.height=chunk$ptall}
print(plotjchunk(chunk))
```

### Hacking

Hacking is defined within VERIS as all attempts to intentionally access or harm information assets without (or exceeding) authorization by circumventing or thwarting logical security mechanisms. Includes brute force, SQL injection, cryptanalysis, denial of service attacks, etc.  Note there is an action category for Hacking and for Misuse. Both can utilize similar vectors and achieve similar results; in Misuse, the actor was granted access/privileges (and used them inappropriately), whereas with Hacking, access/privileges are obtained illegitimately.

```{r warning=F}
chunk <- setjenum(vz, c("action.hacking.variety", "action.hacking.vector"))
```
```{r fig.width=8.5, fig.height=chunk$ptall}
print(plotjchunk(chunk))
```

### Social

Social tactics employ deception, manipulation, intimidation, etc to exploit the human element, or users, of information assets. Includes pretexting, phishing, blackmail, threats, scams, etc.  

_(note: add target here?)_

```{r warning=F}
chunk <- setjenum(vz, c("action.social.variety", "action.social.vector"))
```
```{r fig.width=8.5, fig.height=chunk$ptall}
print(plotjchunk(chunk))
```

### Misuse

Misuse is defined as the use of entrusted organizational resources or privileges for any purpose or manner contrary to that which was intended. Includes administrative abuse, use policy violations, use of non-approved assets, etc. These actions can be malicious or non-malicious in nature. Misuse is exclusive to parties that enjoy a degree of trust from the organization, such as insiders and partners.

```{r warning=F}
chunk <- setjenum(vz, c("action.misuse.variety", "action.misuse.vector"))
```
```{r fig.width=8.5, fig.height=chunk$ptall}
print(plotjchunk(chunk))
```

### Physical

Physical actions encompass deliberate threats that involve proximity, possession, or force. Includes theft, tampering, snooping, sabotage, local device access, assault, etc.  Natural hazards and power failures are often classified under physical threats. We include such events in the Environmental category and restrict the Physical category to intentional actions perpetrated by a human actor. This is done for several reasons, including the assessment of threat frequency and the alignment of controls.

```{r warning=F}
chunk <- setjenum(vz, c("action.physical.variety", "action.physical.vector"))
```
```{r fig.width=8.5, fig.height=chunk$ptall}
print(plotjchunk(chunk))
```

### Error

Error broadly encompasses anything done (or left undone) incorrectly or inadvertently. Includes omissions, misconfigurations, programming errors, trips and spills, malfunctions, etc. It does NOT include something done (or left undone) intentionally or by default that later proves to be unwise or inadequate.

```{r warning=F}
chunk <- setjenum(vz, c("action.error.variety", "action.error.vector"))
```
```{r fig.width=8.5, fig.height=chunk$ptall}
print(plotjchunk(chunk))
```

### Environmental

The Environmental category not only includes natural events such as earthquakes and floods, but also hazards associated with the immediate environment or infrastructure in which assets are located. The latter encompasses power failures, electrical interference, pipe leaks, and atmospheric conditions.

```{r warning=F}
#chunk <- setjenum(vz, c("action.environmental.variety"))
```
```{r fig.width=8.5, fig.height=chunk$ptall}
#print(plotjchunk(chunk))
```

# Compromised Assets

This section describes the information assets that were compromised during the incident. “Compromised” refers to any loss of confidentiality/possession, integrity/authenticity, availability/utility (primary security attributes). Naturally, an incident can involve multiple assets and affect multiple attributes of those assets.

_(Note: How about the other asset variables?)_

```{r warning=F}
chunk <- setjenum(vz, c("asset.assets.variety"))
```
```{r fig.width=8.5, fig.height=chunk$ptall}
print(plotjchunk(chunk))
```

### Other asset variables

```{r warning=F}
try(chunk <- setjenum(vz, c("asset.governance", "asset.country", "asset.cloud")))
```
```{r fig.width=8.5, fig.height=chunk$ptall}
try(print(plotjchunk(chunk)))
```

# Security Attributes

This section describes which security attributes (of the previously-identified assets) were compromised during the incident. To accomplish this, VERIS uses a paired version of the six primary security attributes of confidentiality/possession, integrity/authenticity, availability/utility. An extension of the “C-I-A Triad,” they are commonly called the “Parkerian Hexad,” after their originator, Donn Parker. Multiple attributes can be affected for any one asset and each attribute contains different metrics.

### Confidentiality/Possession

Data victim and state?

```{r echo=F}
att <- getenum(vz, 'attribute')
confidentiality <- format(att$x[att$enum=='Confidentiality'], big.mark=",",scientific=F)
integrity <- format(att$x[att$enum=='Integrity'], big.mark=",",scientific=F)
availability <- format(att$x[att$enum=='Availability'], big.mark=",",scientific=F)
```

There are *`r confidentiality` incidents* with an attribute of confidentiality/possession affected.

Confidentiality refers to limited observation and disclosure of an asset (or data). A loss of confidentiality implies that data were actually observed or disclosed to an unauthorized actor rather than endangered, at-risk, or potentially exposed (the latter fall under the attribute of Possession and Control). Short definition: Limited access, observation, and disclosure.

Possession refers to the owner retaining possession and control of an asset (or data). A loss of possession or control means that the organization no longer has exclusive (or intended) custody and control over the asset or is unable to adequately prove it. The concept of endangerment (exposure to potential compromise or harm) is associated with this attribute whereas actual observation or disclosure of data falls under confidentiality. Short definition: Exclusive ownership and control (and ability to prove it).

```{r warning=F}
chunk <- setjenum(vz, c("attribute.confidentiality.data_disclosure", "attribute.confidentiality.data.variety"))
```
```{r fig.width=8.5, fig.height=chunk$ptall}
print(plotjchunk(chunk))
```

### Data State and Victim

```{r warning=F}
chunk <- setjenum(vz, c("attribute.confidentiality.state", "attribute.confidentiality.data_victim"))
```
```{r fig.width=8.5, fig.height=chunk$ptall}
print(plotjchunk(chunk))
```


### Data variety and spread of record types

```{r}
getdatavariety(vz)
```

A note on the Data Disclosure, for data_disclosure to be 'Yes,' there must be some indication that data was actually viewed or accessed by an unauthorized individual. The following are example scenarios and guidance on how this variable is set:

* Unencrypted stolen or lost device: Potentially
* Encrypted stolen or lost device: No
* Improperly disposed documents or devices: Potentially
* Accidentally publishing private data to a public website (no evidence that anyone viewed it): Potentially
* Misaddressed envelope that was never traced or recovered: Potentially
* Misaddressed envelope that was opened by the incorrect recipient: Yes
* Scenarios not marked No or Potentially will change to Yes if discovered by an outside party. For instance, if an external party notifies the victim of a publishing error, the data is, by definition, disclosed.

### Integrity/Authenticity

There are `r integrity` incidents with an attribute of integrity/authenticity affected.

*Integrity* refers to an asset (or data) being complete and unchanged from the original or authorized state, content, and function. Losses to integrity include unauthorized insertion, modification, manipulation, etc. Short definition: Complete and unchanged from original.

*Authenticity* refers to the validity, conformance, correspondence to intent, and genuineness of the asset (or data). Losses of authenticity include misrepresentation, repudiation, misappropriation, etc. Short definition: Valid, genuine, and conforms to intent.

```{r warning=F}
chunk <- setjenum(vz, c("attribute.integrity.variety"))
```
```{r fig.width=8.5, fig.height=chunk$ptall}
print(plotjchunk(chunk))
```

### Availability/Utility

There are `r availability` incidents with an attribute of availability/utility affected.

*Availability* refers to an asset (or data) being present, accessible, and ready for use when needed. Losses to availability include destruction, deletion, movement, performance impact (delay or acceleration), and interruption. Short definition: Accessible and ready for use when needed

*Utility* refers to the usefulness or fitness of the asset (or data) for a purpose. Losses of utility include obscuration and conversion to a less usable or indecipherable form. Utility is distinguished from availability in that the data are still present but no longer (as) usable. Short definition: Usefulness or fitness for a purpose.

```{r warning=F}
chunk <- setjenum(vz, c("attribute.availability.variety"))
```
```{r fig.width=8.5, fig.height=chunk$ptall}
print(plotjchunk(chunk))
```

# Response
This section focuses on the timeline of the events, how the incident was discovered, and lessons learned during the response and remediation process. It provides useful insight into the detection and defensive capabilities of the organization and helps identify corrective actions needed place to detect and/or prevent similar incidents in the future.

### Incident Timeline

The timeline of events leading up to and following an incident varies greatly depending on a multitude of factors. VERIS tracks the following incident milestones, not all of which are applicable to every incident:

* *First malicious action*: Beginning of the threat actor's malicious actions against the victim. Port scans, initiating a brute-force attack, and even physical recon, are a few examples. This is only relevant to intentional and malicious actions.
* *Initial compromise*: First point at which a security attribute (C/P, I/A, A/U) of an information asset was compromised.
* *Data exfiltration*: First point at which non-public data was taken from the victim environment. Only applicable to data compromise events.
* *Incident discovery*: When the organization first learned the incident had occurred.
* *Containment/restoration*: Point at which the incident is contained (e.g., the “bleeding is stopped”) or restored (e.g., fully functional)”.

Time framing the incident yields extremely useful metrics about threat actors and their actions, security readiness, resiliency, and response of victims, and a host of other factors. Note that the method of tracking timeline information has changed a few times since we published the VERIS framework. Most recently, we changed from collecting a timestamp for each phase to a time span between phases (which is how it was originally).

```{r fig.width=8.5, fig.height=7}
gettimeline(vz)

```

# Discovery Method

The data point identifies how the incident was discovered, which says a great deal about the detective capabilities and readiness of the organization.  Discovery methods are either internal (Int) or external (Ext) shown by the chart on the right.

```{r fig.width=8.5, fig.height=4}
# gad <- function(veris) {
#   chunk <- setjenum(veris, c("discovery_method"))
#   temp <- getenum(veris, "discovery_method")
#   if (nrow(temp)==0) {
#     return(NA)
#   }
#   temp$enum <- substr(temp$enum, 1, 3)
#   pie <- aggregate(x ~ enum, data=temp, FUN=sum)
#   pie <- pie[pie$enum %in% c("Int", "Ext"), ]
#   pie$freq <- round(pie$x/sum(pie$x), 3)
#   pie$n <- sum(pie$x)
#   pie$enum[pie$enum=="Ext"] <- "All External"
#   pie$enum[pie$enum=="Int"] <- "All Internal"
#   gum <- data.table::rbindlist(list(chunk[[1]]$df, pie), fill=TRUE)
#   # gum <- rbind(chunk[[1]]$df, pie)
#   gum$enum <- factor(gum$enum, levels=gum$enum, ordered=T)
#   gum
# }
gum <- getall_discovery(vz)
# gum <- gad(vz)
if (all(is.na(gum))) {
  blank <- textGrob(" ")
  gg <- textGrob(paste("No records with", "discovery_method", "defined.", sep="\n"))
  plot <- arrangeGrob(blank, gg, blank, nrow=1, widths=c(0.5, 1, 0.5))
  print(plot)
} else {
  gg <- simplejbar(gum, paste0("Discovery methods, n=", max(gum$n)), plot.margin=unit(c(0,0,0.1,0), "inches"))
  two <- discovery_pie(vz)
  print(arrangeGrob(gg, two, nrow=1))
#   print(arrangeGrob(gg, nrow=1))
}
```

# Targeted/Opportunistic

Was this a targeted or opportunistic attack?

```{r warning=F}
chunk <- setjenum(vz, c("targeted"), unknowns = c("NA", "Unknown", "Not Applicable"))
```
```{r fig.width=8.5, fig.height=chunk$ptall}
print(plotjchunk(chunk))
```


